/**
 * Created by chenshu on 02/03/2017.
 */var krpanoProps = {bgcolor:{type:String},wmode:{type:String,default:"opaque"},vars:{type:Object},initvars:{type:Object},basepath:{type:String},mwheel:{type:Boolean,default:false},focus:{type:Boolean,default:true},consolelog:{type:Boolean,default:false},mobilescale:{type:Number,default:0.5},fakedevice:{type:String},passQueryParameters:{type:Boolean,default:false},webglsettings:{type:Object}};

var _extends = Object.assign || function (target) {
  for (var i = 1; i < arguments.length; i++) {
    var source = arguments[i];

    for (var key in source) {
      if (Object.prototype.hasOwnProperty.call(source, key)) {
        target[key] = source[key];
      }
    }
  }

  return target;
};

/**
 * Created by chenshu on 02/03/2017.
 */var _window=window; var embedpano=_window.embedpano; var removepano=_window.removepano;if(embedpano==undefined||removepano==undefined){throw new Error("krpano player is required");}var config$2={props:_extends({xml:{type:String,required:true},scene:{type:String},hooks:{type:Object},webvr:{type:Number},debug:{type:Boolean,default:false}},krpanoProps),data:function data(){return{createLock:false,krpanoObjId:"krpano_"+Math.floor(Math.random()*(100000-100+1)+100)};},methods:{createPano:function createPano(){if(!this.createLock&&!this.krpanoObj){this.createLock=true;var vm=this;this.$el.id=this.krpanoObjId+"_container";embedpano({id:this.krpanoObjId,target:this.$el.id,xml:this.xml,bgcolor:this.bgcolor,wmode:this.wmode,vars:this.vars,initvars:this.initvars,basepath:this.basepath,mwheel:this.mwheel,focus:this.focus,consolelog:this.consolelog,mobilescale:this.mobilescale,fakedevice:this.fakedevice,passQueryParameters:this.passQueryParameters,webglsettings:this.webglsettings,onready:function onready(krpanoObj){vm.krpanoObj=krpanoObj;vm.krpanoObj.hooks=vm.hooks;vm.log("pano created");vm.$emit("panoCreated",vm.krpanoObj);vm.createLock=false;},onerror:function onerror(msg){vm.$emit("panoError",msg);vm.createLock=false;}});}},removePano:function removePano(){if(this.krpanoObj){removepano(this.krpanoObj.id);this.log("pano removed");delete this.krpanoObj;}},loadScene:function loadScene(){var scene=this.scene;if(this.krpanoObj&&scene){var str="if(scene["+scene+"]===null,\n                        loadscene(get(scene[0].name),null,MERGE,BLEND(0.5)),\n                        loadscene("+scene+",null,MERGE,BLEND(0.5)))";this.krpanoObj.call(str);this.log("scene changed: "+scene);this.$emit("sceneChanged",scene);}},enterVr:function enterVr(){var scene=this.scene;if(this.krpanoObj&&scene){console.log(scene,'enterVr');}},log:function log(content){if(this.debug){if(this.krpanoObj){content="["+this.krpanoObj.id+"] "+content;}console.debug(content);}}},watch:{xml:function xml(oldXml,newXml){if(this.krpanoObj&&newXml){if(oldXml){newXml=newXml.split("/").pop();}this.krpanoObj.call("loadpano("+newXml+",null,IGNOREKEEP)");this.$emit("xmlChanged",newXml);this.log("xml changed: "+newXml);}},scene:function scene(){this.loadScene();},webvr:function webvr(value){if(this.krpanoObj){this.krpanoObj.call('webvr.toggleVR();');}}},created:function created(){this.$on(["panoCreated","xmlChanged"],this.loadScene);},beforeDestroy:function beforeDestroy(){this.removePano();}};

/**
 * Created by chenshu on 02/03/2017.
 */var config$3={props:{lazyLoad:{type:Boolean,default:true}},mounted:function mounted(){if(this.lazyLoad){this.createLock=true;this.scrollListener();window.addEventListener("scroll",this.scrollListener);}else{this.createPano();}},methods:{scrollListener:function scrollListener(){var rect=this.$el.getBoundingClientRect();if(-rect.top>rect.height||rect.top>window.innerHeight){//屏幕之外
if(this.krpanoObj){this.krpanoObj.call("if(autorotate.enabled,autorotate.pause())");this.log("out of screen: autorotate paused");}}else{//屏幕之内
if(!this.krpanoObj){this.createLock=false;//lazy load
this.createPano();}else{this.krpanoObj.call("if(autorotate.enabled,autorotate.resume())");this.log("in screen: autorotate resumed");}}}}};

/**
 * Created by chenshu on 03/03/2017.
 */var config$4={props:{freezeVertical:{type:Boolean,default:false}},data:function data(){return{eventDelegate:undefined};},methods:{},watch:{freezeVertical:function freezeVertical(val){if(this.eventDelegate){if(val){this.eventDelegate.style.display="block";var hlookat=this.krpanoObj.get("view.hlookat");this.krpanoObj.call("lookat("+hlookat+",0)");}else{this.eventDelegate.style.display="none";}}}},created:function created(){var _this=this;if(TouchEvent){this.$on("panoCreated",function(krpano){var origin=krpano.firstChild;var eventDelegate=document.createElement("DIV");eventDelegate.className="event-delegate";Object.assign(eventDelegate.style,{display:_this.freezeVertical?"block":"none",width:"100%",height:"100%",position:"absolute","user-select":"none","z-index":1});krpano.appendChild(eventDelegate);_this.eventDelegate=eventDelegate;var originTouch=void 0;eventDelegate.addEventListener("touchstart",function(e){originTouch=e;Object.defineProperty(e,"cancelable",{value:true});var event=new TouchEvent("touchstart",e);return origin.dispatchEvent(event);});eventDelegate.addEventListener("touchend",function(e){Object.defineProperty(e,"cancelable",{value:true});var event=new TouchEvent("touchend",e);return origin.dispatchEvent(event);});eventDelegate.addEventListener("touchmove",function(e){var currentTouch=e.changedTouches[0];var deltaX=originTouch.clientX-currentTouch.clientX;var hlookat=krpano.get("view.hlookat")+deltaX;var vlookat=krpano.get("view.vlookat");krpano.call("lookat("+hlookat+","+vlookat+")");originTouch=currentTouch;return true;});eventDelegate.addEventListener("mousedown",function(e){Object.defineProperty(e,"cancelable",{value:true});return origin.dispatchEvent(new MouseEvent("mousedown",e));});eventDelegate.addEventListener("mousewheel",function(e){Object.defineProperty(e,"cancelable",{value:true});return origin.dispatchEvent(new MouseEvent("mousewheel",e));});});}}};

/**
 * Created by chenshu on 02/03/2017.
 */var config$5={props:{hotspots:{type:Array,default:function _default(){return[];}}},mounted:function mounted(){this.createHotspots();},methods:{addHotspot:function addHotspot(it,_ref){var v=_ref.v,h=_ref.h,scale=_ref.scale;var spotname="hotspot"+it;var url='./static/vr/hotspot.png';this.krpanoObj.call("\n        addhotspot("+spotname+");\n        set(hotspot["+spotname+"].url, "+url+");\n        set(hotspot["+spotname+"].ath, "+h+");\n        set(hotspot["+spotname+"].atv, "+v+");\n        set(hotspot["+spotname+"].scale, "+scale+");\n        set(hotspot["+spotname+"].onclick, jscall(calc('krpano.hooks.onHotspotClick(\""+spotname+"\")')));\n      ");},createHotspots:function createHotspots(){for(var i=0;i<this.hotspots.length;i++){this.addHotspot(i,this.hotspots[i]);}}},watch:{hotspots:function hotspots(){this.createHotspots();}}};

/**
 * Created by chenshu on 02/03/2017.
 */var config$6={props:{setups:{type:Array,default:function _default(){return[];}},views:{type:Array,default:function _default(){return[];}},route:{type:Object,default:function _default(){return{};}}},mounted:function mounted(){this.createNavi();},methods:{createHotspot:function createHotspot(name,ath,atv,image,ico,scale,hook,enabled){this.krpanoObj.call('\n        addhotspot('+name+');\n        set(hotspot['+name+'].url, %FIRSTXML%/interface/'+image+'.png);\n        set(hotspot['+name+'].ath, '+ath+');\n        set(hotspot['+name+'].atv, '+atv+');\n        set(hotspot['+name+'].scale, '+scale+');\n        set(hotspot['+name+'].distorted, true);\n        set(hotspot['+name+'].enabled, '+enabled+');\n        set(hotspot['+name+'].onclick, jscall(calc(\'krpano.hooks.'+hook+'\')));\n      ');this.krpanoObj.call('\n        addhotspot('+name+'_ico);\n        set(hotspot['+name+'_ico].url, %FIRSTXML%/interface/'+ico+'.png);\n        set(hotspot['+name+'_ico].ath, '+ath+');\n        set(hotspot['+name+'_ico].atv, '+atv+');\n        set(hotspot['+name+'_ico].scale, '+scale+');\n        set(hotspot['+name+'_ico].distorted, true);\n        set(hotspot['+name+'_ico].enabled, false);\n      ');},addlabel:function addlabel(name,ath,atv){this.krpanoObj.call('\n        addhotspot('+name+');\n        set(hotspot['+name+'].url, %FIRSTXML%/interface/'+name+'.png);\n        set(hotspot['+name+'].ath, '+ath+');\n        set(hotspot['+name+'].atv, '+atv+');\n        set(hotspot['+name+'].scale, .2);\n        set(hotspot['+name+'].distorted, true);\n        set(hotspot['+name+'].enabled, false);\n      ');},addSectionHotspots:function addSectionHotspots(name,rz,atv,ath,index){var current=Number(this.route.params.section)==index;this.krpanoObj.call('\n        addhotspot('+name+');\n        set(hotspot['+name+'].url, %FIRSTXML%/interface/btn_'+name+'_'+(current?'on':'off')+'.png);\n        set(hotspot['+name+'].ath, '+ath+');\n        set(hotspot['+name+'].atv, '+atv+');\n        set(hotspot['+name+'].rz, '+rz+');\n        set(hotspot['+name+'].scale, .105);\n        set(hotspot['+name+'].distorted, true);\n        set(hotspot['+name+'].onclick, jscall(calc(\'krpano.hooks.gotoSection('+index+')\')) );\n      ');},addHudHotspots:function addHudHotspots(hudOn){var image=hudOn?'btn':'btn_active';this.createHotspot('hud_show',-40,52,image,'show',.25,'toggleHud()',!hudOn);image=!hudOn?'btn':'btn_active';this.createHotspot('hud_hide',-32,52,image,'hide',.25,'toggleHud()',hudOn);},addViewHotspot:function addViewHotspot(it,active){console.log(active);var spotname='view_'+(it+1);var image=active?'btn':'btn_active';var h=-18+it*8;var v=52;this.createHotspot(spotname,h,v,image,it+1,.25,'gotoView('+it+')',!active);},addSetupHotspot:function addSetupHotspot(it,energyLevel,active){var spotname='setup_'+(it+1);var image=active?'level_'+energyLevel:'level_'+energyLevel+'_active';var h=-12+this.views.length*8+it*8;var v=52;this.createHotspot(spotname,h,v,image,it+1,.25,'gotoSetup('+it+')',!active);},createNavi:function createNavi(){var _this=this;if(!this.krpanoObj){// Fixing the fact that krpano may be not yet initialized on mobile phone app
setTimeout(function(){_this.createNavi();},2000);return;}else{this.krpanoObj.call('webvr.enterVR();');}if(this.views.length==0)return;this.addlabel('text_hud',-36,55);this.addlabel('text_view',-10,55);var setupLabelH=this.setups.length===4?24:20;this.addlabel('text_setup',setupLabelH,55);this.addSectionHotspots('ee',17,62,-20,0);this.addSectionHotspots('aq',0,63.4,0,1);this.addSectionHotspots('hs',-17,62,20,2);this.addHudHotspots(this.route.path.indexOf('hud')>-1);for(var i=0;i<this.views.length;i++){var routeView=Number(this.route.params.view)||0;this.addViewHotspot(i,routeView===i);}for(var _i=0;_i<this.setups.length;_i++){var routeSetup=Number(this.route.params.setup)||0;this.addSetupHotspot(_i,this.setups[_i].energy_level,routeSetup===_i);}}},watch:{route:function route(){this.createNavi();}}};

/**
 * Created by chenshu on 02/03/2017.
 */var config={mixins:[config$2,config$3,config$4,config$5,config$6],template:"<div class='vue-krpano'></div>",mounted:function mounted(){this.createPano();}};

export default config;
